# ç¬¬å…«ç«  DACæ³¢å½¢ä»‹ç»åŠä½¿ç”¨

> ğŸ“Œ **æœ¬ç« ç›®æ ‡**ï¼šæ·±å…¥æŒæ¡ RA6E2 çš„ **DACï¼ˆDigital-to-Analog Converterï¼‰æ¨¡å—æ¶æ„ã€åŒé€šé“ç‹¬ç«‹è¾“å‡ºã€GPTå®šæ—¶è§¦å‘ã€DTCè‡ªåŠ¨æ³¢å½¢ç”Ÿæˆã€æ­£å¼¦æ³¢/ä¸‰è§’æ³¢è¾“å‡ºã€ç²¾åº¦ä¼˜åŒ–ä¸å…¸å‹åº”ç”¨åœºæ™¯**ï¼Œå®ç°é«˜ä¿çœŸæ¨¡æ‹Ÿä¿¡å·è¾“å‡ºç³»ç»Ÿã€‚

---

## 1. RA6E2 DAC æ¨¡å—ç®€ä»‹

RA6E2 é›†æˆ **12 ä½é«˜ç²¾åº¦ DAC**ï¼Œæ”¯æŒåŒé€šé“ç‹¬ç«‹è¾“å‡ºï¼Œæ˜¯ RA6E2 ä¸­é«˜æ€§èƒ½æ¨¡æ‹Ÿè¾“å‡ºçš„æ ¸å¿ƒæ¨¡å—ã€‚

### 1.1 æ ¸å¿ƒç‰¹æ€§

| ç‰¹æ€§     | è¯´æ˜                                              |
| ------ | ----------------------------------------------- |
| åˆ†è¾¨ç‡    | 12 ä½ï¼ˆ0 ~ 4095ï¼‰                                  |
| è¾“å‡ºé€šé“   | **2 é€šé“ï¼ˆDAC0, DAC1ï¼‰**ï¼Œå¯ç‹¬ç«‹é…ç½®                      |
| è¾“å‡ºç”µå‹èŒƒå›´ | 0 ~ VREFï¼ˆå…¸å‹ä¸º 3.3Vï¼Œå¯å¤–æ¥é«˜ç²¾åº¦åŸºå‡†ï¼‰                     |
| å»ºç«‹æ—¶é—´   | å…¸å‹ 5 Î¼sï¼ˆä»æ•°å­—è¾“å…¥åˆ°æ¨¡æ‹Ÿç¨³å®šï¼‰                             |
| è§¦å‘æ–¹å¼   | è½¯ä»¶è§¦å‘ã€GPTå®šæ—¶è§¦å‘ã€å¤–éƒ¨è§¦å‘                               |
| æ•°æ®ä¼ è¾“   | æ”¯æŒ DTCï¼ˆData Transfer Controllerï¼‰è‡ªåŠ¨åŠ è½½æ•°æ®ï¼Œå®ç°è¿ç»­æ³¢å½¢è¾“å‡º |
| ç¼“å†²è¾“å‡º   | âœ… å†…ç½®ç”µå‹ç¼“å†²å™¨ï¼Œå¯ç›´æ¥é©±åŠ¨è´Ÿè½½ï¼ˆå¦‚è¿æ”¾è¾“å…¥ï¼‰                        |
| ä½åŠŸè€—æ¨¡å¼  | æ”¯æŒå¾…æœºæ¨¡å¼ï¼Œå…³é—­æ—¶åŠŸè€—æä½                                  |

ğŸ“Œ **å…¸å‹åº”ç”¨åœºæ™¯**ï¼š

- æ³¢å½¢å‘ç”Ÿå™¨ï¼ˆæ­£å¼¦ã€ä¸‰è§’ã€é”¯é½¿æ³¢ï¼‰
- éŸ³é¢‘ä¿¡å·è¾“å‡ºï¼ˆä½é‡‡æ ·ç‡ï¼‰
- æ¨¡æ‹Ÿç”µå‹è®¾å®šï¼ˆç”µæºæ§åˆ¶ï¼‰
- ç”µæœºæ§åˆ¶å‚è€ƒç”µå‹
- ä¼ æ„Ÿå™¨æ¨¡æ‹Ÿä¿¡å·æ³¨å…¥

---

### 1.2 DAC vs ADC å¯¹æ¯”

| é¡¹ç›®     | ADCï¼ˆä¸Šä¸€ç« ï¼‰            | DACï¼ˆæœ¬ç« ï¼‰             |
| ------ | ------------------- | ------------------- |
| åŠŸèƒ½     | æ¨¡æ‹Ÿ â†’ æ•°å­—ï¼ˆé‡‡é›†ï¼‰         | æ•°å­— â†’ æ¨¡æ‹Ÿï¼ˆè¾“å‡ºï¼‰         |
| åˆ†è¾¨ç‡    | 12 ä½                | 12 ä½                |
| è§¦å‘æ–¹å¼   | è½¯ä»¶ã€GPTã€DTCï¼ˆè¾“å…¥ï¼‰      | è½¯ä»¶ã€GPTã€DTCï¼ˆè¾“å‡ºï¼‰      |
| æ•°æ®æ–¹å‘   | å¤–è®¾ â†’ å†…å­˜             | å†…å­˜ â†’ å¤–è®¾             |
| å…¸å‹å¤–è®¾è”åŠ¨ | GPTï¼ˆå®šæ—¶é‡‡æ ·ï¼‰ + DTCï¼ˆæ¬è¿ï¼‰ | GPTï¼ˆå®šæ—¶æ›´æ–°ï¼‰ + DTCï¼ˆé€æ•°ï¼‰ |

> âœ… **DAC æ˜¯ ADC çš„â€œé•œåƒâ€**ï¼Œä½†æ•°æ®æµå‘ç›¸åã€‚

---

## 2. FSP å›¾å½¢åŒ–é…ç½® DAC

### 2.1 æ·»åŠ  DAC æ¨¡å—

1. æ‰“å¼€ `FSP Configuration` â†’ `Threads` â†’ `hal_entry` â†’ ç‚¹å‡» `+`
2. é€‰æ‹© `Driver` â†’ `Analog` â†’ `DAC`
3. æ·»åŠ  `g_dac0`ï¼ˆå¯¹åº” DAC0ï¼‰

---

### 2.2 é…ç½®åŸºæœ¬å‚æ•°ï¼ˆPropertiesï¼‰

| å‚æ•°                    | æ¨èå€¼/è¯´æ˜                                  |
| --------------------- | --------------------------------------- |
| **Unit**              | 0ï¼ˆDAC0ï¼‰ æˆ– 1ï¼ˆDAC1ï¼‰                       |
| **Resolution**        | `12-bit`                                |
| **Reference Voltage** | `VREF`ï¼ˆå¤–éƒ¨ï¼‰ æˆ– `Internal`ï¼ˆå†…éƒ¨ 1.2Vï¼‰        |
| **Trigger Mode**      | `Software`ï¼ˆè½¯ä»¶è§¦å‘ï¼‰ æˆ– `Hardware`ï¼ˆGPT å®šæ—¶è§¦å‘ï¼‰ |
| **Output Buffer**     | âœ… Enableï¼ˆå¯ç”¨è¾“å‡ºç¼“å†²ï¼Œæé«˜é©±åŠ¨èƒ½åŠ›ï¼‰                 |
| **DTC Support**       | âœ… Enableï¼ˆå…è®¸ DTC è‡ªåŠ¨å†™å…¥æ•°æ®ï¼‰                 |

---

### 2.3 é…ç½® DTC æ•°æ®ä¼ è¾“ï¼ˆå…³é”®ï¼ï¼‰

1. æ·»åŠ  `DTC` æ¨¡å—ï¼ˆDriver â†’ Transfer â†’ DTCï¼‰
2. åœ¨ DAC é…ç½®ä¸­ï¼š
   - `Transfer Info` â†’ `Enable`
   - `Source Address`: é€‰æ‹©æ³¢å½¢æ•°æ®æ•°ç»„ï¼ˆå¦‚ `g_sine_wave`ï¼‰
   - `Number of Transfers`: æ³¢å½¢ç‚¹æ•°ï¼ˆå¦‚ 256ï¼‰
   - `Mode`: `Repeat`ï¼ˆå¾ªç¯å‘é€ï¼Œå®ç°è¿ç»­æ³¢å½¢ï¼‰

> âœ… DTC + GPT å®ç° **æ—  CPU å¹²é¢„çš„è¿ç»­æ³¢å½¢è¾“å‡º**ï¼

---

### 2.4 é…ç½®å¼•è„šï¼ˆPins æ ‡ç­¾é¡µï¼‰

- æ‰¾åˆ° `DA0`ï¼ˆDAC0 è¾“å‡ºï¼‰â†’ è®¾ç½®ä¸º `Analog Output`
- ç¡®ä¿æœªå¯ç”¨ä¸Šä¸‹æ‹‰æˆ–æ•°å­—åŠŸèƒ½

> ğŸ“Œ æ³¨æ„ï¼šRA6E2 çš„ DAC è¾“å‡ºå¼•è„šæ˜¯å›ºå®šçš„ï¼ˆå¦‚ DA0 = P409, DA1 = P410ï¼‰ï¼Œ**ä¸æ”¯æŒå¤ç”¨åˆ°å…¶ä»–å¼•è„š**ã€‚

---

## 3. DAC ç›¸å…³ FSP å‡½æ•°è¯¦è§£

> ğŸ“Œ æ‰€æœ‰å‡½æ•°å£°æ˜åœ¨ `r_dac.h` ä¸­ã€‚

---

### 3.1 R_DAC_Open

#### 3.1.1 å‡½æ•°åŸå‹åŠåŠŸèƒ½

åˆå§‹åŒ– DAC æ¨¡å—ã€‚

```c
fsp_err_t R_DAC_Open(dac_ctrl_t * const p_ctrl, dac_cfg_t const * const p_cfg)
```

#### 3.1.2 å‚æ•°

- `dac_ctrl_t * const p_ctrl`ï¼šæ§åˆ¶å¥æŸ„ï¼ˆå¦‚ `g_dac0_ctrl`ï¼‰
- `dac_cfg_t const * const p_cfg`ï¼šé…ç½®ç»“æ„ä½“ï¼ˆå¦‚ `g_dac0_cfg`ï¼‰

#### 3.1.3 è¿”å›å€¼

- `FSP_SUCCESS`ï¼šæˆåŠŸ
- `FSP_ERR_ASSERTION`
- `FSP_ERR_ALREADY_OPEN`
- `FSP_ERR_INVALID_ARGUMENT`

ğŸ“Œ **å…¸å‹ç”¨æ³•**ï¼š

```c
fsp_err_t err = R_DAC_Open(&g_dac0_ctrl, &g_dac0_cfg);

if (FSP_SUCCESS != err) while(1);
```

---

### 3.2 R_DAC_Write

#### 3.2.1 å‡½æ•°åŸå‹åŠåŠŸèƒ½

å†™å…¥ DAC æ•°å­—å€¼ï¼ˆ12ä½ï¼‰ï¼Œç«‹å³æˆ–åœ¨è§¦å‘åæ›´æ–°æ¨¡æ‹Ÿè¾“å‡ºã€‚

```c
fsp_err_t R_DAC_Write(dac_ctrl_t * const p_ctrl, uint16_t const data)
```

#### 3.2.2 å‚æ•°

- `data`ï¼šè¦è¾“å‡ºçš„æ•°å­—å€¼ï¼ˆ0 ~ 4095ï¼‰

ğŸ“Œ **æ³¨æ„**ï¼š

- è‹¥ `Trigger Mode = Software`ï¼Œè°ƒç”¨ `Write` åç«‹å³æ›´æ–°è¾“å‡ºã€‚
- è‹¥ `Trigger Mode = Hardware`ï¼Œ`Write` ä»…åŠ è½½æ•°æ®ï¼Œç”± GPT è§¦å‘æ›´æ–°ã€‚

---

### 3.3 R_DAC_Start

#### 3.3.1 å‡½æ•°åŸå‹åŠåŠŸèƒ½

å¯åŠ¨ DAC è¾“å‡ºï¼ˆä½¿èƒ½ DAC æ¨¡å—ï¼‰ã€‚

```c
fsp_err_t R_DAC_Start(dac_ctrl_t * const p_ctrl)
```

ğŸ“Œ **é‡è¦**ï¼š`R_DAC_Open` å DAC **é»˜è®¤ä¸å·¥ä½œ**ï¼Œå¿…é¡»è°ƒç”¨ `Start`ï¼

---

### 3.4 R_DAC_Stop

#### 3.4.1 å‡½æ•°åŸå‹åŠåŠŸèƒ½

åœæ­¢ DAC è¾“å‡ºï¼Œè¿›å…¥ä½åŠŸè€—çŠ¶æ€ã€‚

```c
fsp_err_t R_DAC_Stop(dac_ctrl_t * const p_ctrl)
```

---

### 3.5 R_DAC_Close

#### 3.5.1 å‡½æ•°åŸå‹åŠåŠŸèƒ½

å…³é—­ DAC æ¨¡å—ï¼Œé‡Šæ”¾èµ„æºã€‚

```c
fsp_err_t R_DAC_Close(dac_ctrl_t * const p_ctrl)
```

---

## 4. DAC ä¸­æ–­å›è°ƒå‡½æ•°

FSP è‡ªåŠ¨ç”Ÿæˆå›è°ƒæ¡†æ¶ï¼š

```c
void dac_callback(dac_callback_args_t *p_args)
{
    switch(p_args->event)
    {
        case DAC_EVENT_CYCLE_END:
            // DTC ä¸€ä¸ªå‘¨æœŸä¼ è¾“å®Œæˆï¼ˆå¯ç”¨äºåˆ‡æ¢æ³¢å½¢ï¼‰
            g_dac_cycle_complete = true;
            break;

        case DAC_EVENT_TRANSFER_ABORTED:
            // ä¼ è¾“è¢«ä¸­æ­¢
            break;

        default:
            break;
    }
}
```

ğŸ“Œ **åœ¨ DTC æ¨¡å¼ä¸‹ï¼Œ`DAC_EVENT_CYCLE_END` æ ‡å¿—ä¸€ä¸ªæ³¢å½¢å‘¨æœŸç»“æŸ**ã€‚

---

## 5. å®æˆ˜1ï¼šè½¯ä»¶è§¦å‘ DAC è¾“å‡ºå¯å˜ç”µå‹ï¼ˆç”µä½å™¨æ¨¡æ‹Ÿï¼‰

```c
#include "hal_data.h"

void hal_entry(void)
{
    R_DAC_Open(&g_dac0_ctrl, &g_dac0_cfg);
    R_DAC_Start(&g_dac0_ctrl);

    uint16_t dac_value = 0;
    int8_t   direction = 1;

    while(1)
    {
        // æ¨¡æ‹Ÿç”µä½å™¨æ—‹è½¬
        dac_value += direction * 64;
        if (dac_value >= 4090) {
            dac_value = 4090;
            direction = -1;
        } else if (dac_value == 0) {
            direction = 1;
        }

        R_DAC_Write(&g_dac0_ctrl, dac_value);

        // è®¡ç®—è¾“å‡ºç”µå‹
        float voltage = (dac_value / 4095.0f) * 3.3f;

        char msg[32];
        snprintf(msg, sizeof(msg), "DAC: %u (%.2fV)\r\n", dac_value, voltage);
        R_SCI_UART_Write(&g_uart0_ctrl, (uint8_t*)msg, strlen(msg));

        R_BSP_SoftwareDelay(200, BSP_DELAY_UNITS_MILLISECONDS);
    }
}
```

---

## 6. å®æˆ˜2ï¼šDTC + GPT ç”Ÿæˆè¿ç»­æ­£å¼¦æ³¢

### 6.1 ç”Ÿæˆæ­£å¼¦æ³¢æ•°æ®è¡¨

```c
#define SINE_TABLE_SIZE 256
#define DAC_MAX         4095
#define DAC_OFFSET      2048  // 0V åç§»ï¼ˆè‹¥éœ€è¦åŒææ€§ï¼‰
#define AMPLITUDE       2000  // æŒ¯å¹…ï¼ˆé¿å…å‰Šé¡¶ï¼‰

static uint16_t g_sine_wave[SINE_TABLE_SIZE];

void init_sine_wave(void)
{
    for (int i = 0; i < SINE_TABLE_SIZE; i++)
    {
        float angle = (2.0f * M_PI * i) / SINE_TABLE_SIZE;
        float value = sinf(angle);
        g_sine_wave[i] = (uint16_t)(DAC_OFFSET + AMPLITUDE * value);
    }
}
```

### 6.2 FSP é…ç½®è¦ç‚¹

- **DAC Trigger Mode**: `Hardware`
- **Hardware Trigger Source**: `GPT0`ï¼ˆå‘¨æœŸè§¦å‘ï¼‰
- **DTC**:
  - `Source`: `g_sine_wave`
  - `Destination`: `DAC0 DADR`ï¼ˆæ•°æ®å¯„å­˜å™¨ï¼‰
  - `Mode`: `Repeat`
- **GPT0**: é…ç½®ä¸º 256kHz PWMï¼ˆç”¨äº 1kHz æ­£å¼¦æ³¢ï¼‰

> ğŸ“Œ è®¡ç®—ï¼š256kHz / 256ç‚¹ = 1000Hz æ­£å¼¦æ³¢

### 6.3 ä»£ç å®ç°

```c
#include "hal_data.h"

void hal_entry(void)
{
    init_sine_wave();

    R_DAC_Open(&g_dac0_ctrl, &g_dac0_cfg);
    R_GPT_Open(&g_gpt0_ctrl, &g_gpt0_cfg);  // å¯åŠ¨ GPT è§¦å‘
    R_GPT_Start(&g_gpt0_ctrl);
    R_DAC_Start(&g_dac0_ctrl);              // å¯åŠ¨ DACï¼ŒDTC è‡ªåŠ¨é€æ•°

    while(1)
    {
        // ä¸»å¾ªç¯å¯æ‰§è¡Œå…¶ä»–ä»»åŠ¡
        if (g_dac_cycle_complete)
        {
            g_dac_cycle_complete = false;
            // å¯åœ¨æ­¤åˆ‡æ¢æ³¢å½¢æˆ–è°ƒæ•´é¢‘ç‡
        }

        R_BSP_SoftwareDelay(100, BSP_DELAY_UNITS_MILLISECONDS);
    }
}
```

ğŸ“Œ **æ•ˆæœ**ï¼šP409 å¼•è„šè¾“å‡º **1kHz æ­£å¼¦æ³¢**ï¼ŒCPU å ç”¨ç‡æ¥è¿‘ 0%ï¼

---

## 7. å¸¸è§æ³¢å½¢æ•°æ®ç”Ÿæˆå‡½æ•°

### 7.1 ä¸‰è§’æ³¢

```c
for (int i = 0; i < size; i++)
{
    if (i < size/2) {
        wave[i] = (4095 * 2 * i) / size;
    } else {
        wave[i] = 4095 - ((4095 * 2 * (i - size/2)) / size);
    }
}
```

### 7.2 é”¯é½¿æ³¢

```c
for (int i = 0; i < size; i++)
{
    wave[i] = (4095 * i) / size;
}
```

### 7.3 æ–¹æ³¢ï¼ˆå ç©ºæ¯”å¯è°ƒï¼‰

```c
int high_count = (duty_ratio * size) / 100;
for (int i = 0; i < size; i++)
{
    wave[i] = (i < high_count) ? 4095 : 0;
}
```

---

## 8. DAC ç²¾åº¦ä¼˜åŒ–ä¸æ³¨æ„äº‹é¡¹

### 8.1 æé«˜è¾“å‡ºç²¾åº¦

| æ–¹æ³•           | è¯´æ˜                        |
| ------------ | ------------------------- |
| ä½¿ç”¨å¤–éƒ¨é«˜ç²¾åº¦ VREF | å¦‚ REF3033ï¼ˆ3.3Vï¼Œ0.5% ç²¾åº¦ï¼‰   |
| å¢åŠ è¾“å‡ºæ»¤æ³¢       | åŠ  RC ä½é€šæ»¤æ³¢å™¨ï¼ˆå¦‚ 1kÎ© + 100nFï¼‰ |
| é¿å…ç”µæºå™ªå£°       | DAC ç”µæºåŠ  0.1Î¼F é™¶ç“·ç”µå®¹å»è€¦      |
| é™ä½æ›´æ–°é¢‘ç‡       | é«˜é¢‘æ›´æ–°å¯èƒ½å¼•èµ·å»ºç«‹ä¸å®Œå…¨             |
| ä½¿ç”¨ç¼“å†²è¾“å‡º       | âœ… å¯ç”¨ Output Bufferï¼Œæé«˜é©±åŠ¨èƒ½åŠ› |

---

### 8.2 å»ºç«‹æ—¶é—´ä¸æœ€å¤§æ›´æ–°é¢‘ç‡

```c
æœ€å¤§æ›´æ–°é¢‘ç‡ < 1 / å»ºç«‹æ—¶é—´
â†’ å…¸å‹ 5Î¼s å»ºç«‹æ—¶é—´ â†’ æœ€å¤§æ›´æ–°é¢‘ç‡ ~ 200kHz
```

ğŸ“Œ **æ³¨æ„**ï¼šè¶…è¿‡æ­¤é¢‘ç‡ï¼Œè¾“å‡ºæ³¢å½¢å°†å¤±çœŸï¼

---

## 9. DAC å‡½æ•°é€ŸæŸ¥è¡¨

| å‡½æ•°å            | ç”¨é€”      | å…³é”®å‚æ•°              | è¿”å›å€¼/é”™è¯¯ç         | æ³¨æ„äº‹é¡¹      |
| -------------- | ------- | ----------------- | -------------- | --------- |
| `R_DAC_Open`   | åˆå§‹åŒ–DAC  | `p_ctrl`, `p_cfg` | `ALREADY_OPEN` | å¿…é¡»æœ€å…ˆè°ƒç”¨    |
| `R_DAC_Write`  | å†™å…¥æ•°å­—å€¼   | `data` (0~4095)   | `INVALID_ARG`  | è§¦å‘åæ›´æ–°æ¨¡æ‹Ÿè¾“å‡º |
| `R_DAC_Start`  | å¯åŠ¨DACè¾“å‡º | -                 | -              | Openåå¿…é¡»è°ƒç”¨ |
| `R_DAC_Stop`   | åœæ­¢DAC   | -                 | -              | è¿›å…¥ä½åŠŸè€—     |
| `R_DAC_Close`  | å…³é—­DAC   | -                 | -              | é‡Šæ”¾èµ„æº      |
| `dac_callback` | DTCå®Œæˆå›è°ƒ | `p_args->event`   | æ— è¿”å›å€¼           | æ³¢å½¢å‘¨æœŸç»“æŸæ ‡å¿—  |

---

## 10. å¼€å‘å»ºè®®

âœ… **æ¨èåšæ³•**ï¼š

1. **è¿ç»­æ³¢å½¢è¾“å‡º â†’ ä½¿ç”¨ GPT + DTC æ¨¡å¼**
2. **é«˜ä¿çœŸè¾“å‡º â†’ åŠ  RC æ»¤æ³¢ï¼Œä½¿ç”¨å¤–éƒ¨ VREF**
3. **åŒé€šé“åŒæ­¥ â†’ ä½¿ç”¨åŒä¸€ GPT è§¦å‘ä¸¤ä¸ª DAC**
4. **ä½åŠŸè€—åº”ç”¨ â†’ ç”¨å®Œè°ƒç”¨ `R_DAC_Stop`**
5. **éŸ³é¢‘è¾“å‡º â†’ é‡‡æ ·ç‡ â‰¤ 20kHzï¼Œé¿å…é«˜é¢‘å¤±çœŸ**

â›” **é¿å…åšæ³•**ï¼š

1. **åœ¨ `while(1)` ä¸­é¢‘ç¹è°ƒç”¨ `R_DAC_Write`**ï¼ˆåº”ä½¿ç”¨ DTCï¼‰
2. **æ›´æ–°é¢‘ç‡è¶…è¿‡ 200kHz**ï¼ˆå»ºç«‹æ—¶é—´ä¸è¶³ï¼‰
3. **å¿½ç•¥ç”µæºå»è€¦**ï¼ˆå¯¼è‡´è¾“å‡ºå™ªå£°å¤§ï¼‰

---


